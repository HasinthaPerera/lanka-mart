<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lanka Mart - Admin Panel</title>
    
    <link rel="stylesheet" href="admin.css">
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p>Verifying Admin Access...</p>
    </div>

    <div id="dashboard-content">
        
        <div class="header">
            <div>
                <h1 style="margin:0;">Admin Dashboard</h1>
                <small style="color: gray;">Logged in as: <span id="admin-email-display"></span></small>
            </div>
            <button id="logout-btn" class="logout-btn">Log Out</button>
        </div>

        <div class="card">
            <h2 style="margin-top:0;">Add New Product</h2>
            <form id="add-product-form">
                
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="product-name" placeholder="e.g. Red Apple" required>
                </div>

                <div class="form-group">
                    <label>Price (LKR)</label>
                    <input type="number" id="product-price" placeholder="e.g. 150" required>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="product-category">
                        <option value="vegetables">Vegetables</option>
                        <option value="fruits">Fruits</option>
                        <option value="dairy">Dairy</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Image URL</label>
                    <input type="url" id="product-image" placeholder="https://..." required>
                </div>

                <button type="submit" class="submit-btn">Upload Product</button>
            </form>
        </div>
    </div>

    <script type="module">
        // Import Firebase SDKs
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Import Secrets from your local file
        import { firebaseConfig, ADMIN_EMAIL } from './config.js';

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- SECURITY CHECKER ---
        onAuthStateChanged(auth, (user) => {
            const loadingScreen = document.getElementById('loading-screen');
            const dashboard = document.getElementById('dashboard-content');

            // 1. Check if user is logged in AND email matches config.js
            if (user && user.email === ADMIN_EMAIL) {
                // ALLOW ACCESS
                console.log("Welcome, Admin.");
                document.getElementById('admin-email-display').textContent = user.email;
                
                // Hide loader, Show Dashboard
                loadingScreen.style.display = 'none';
                dashboard.style.display = 'block';
            } else {
                // DENY ACCESS
                console.warn("Access Denied.");
                alert("You are not authorized to view this page.");
                window.location.href = "index.html"; // Kick to home
            }
        });

        // --- LOGOUT FUNCTION ---
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => {
                window.location.href = "index.html";
            });
        });

        // --- ADD PRODUCT FUNCTION ---
        const productForm = document.getElementById('add-product-form');
        
        productForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            // Get values from inputs
            const name = document.getElementById('product-name').value;
            const price = Number(document.getElementById('product-price').value);
            const category = document.getElementById('product-category').value;
            const image = document.getElementById('product-image').value;

            try {
                // Add to Firestore Database
                await addDoc(collection(db, "products"), {
                    name: name,
                    price: price,
                    category: category,
                    imageUrl: image,
                    createdAt: new Date()
                });
                
                alert("Product Added Successfully!");
                productForm.reset(); // Clear the form
            } catch (error) {
                console.error("Error adding product: ", error);
                alert("Error adding product. Check console for details.");
            }
        });
    </script>

</body>
</html>