<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lanka Mart - Admin Panel</title>
    <link rel="stylesheet" href="admin.css">
</head>
<body>

    <div id="loading-screen">
        <div class="spinner"></div>
        <p>Verifying Admin Access...</p>
    </div>

    <div id="dashboard-content">
        
        <div class="header">
            <div>
                <h1 style="margin:0;">Admin Dashboard</h1>
                <small style="color: gray;">Logged in as: <span id="admin-email-display"></span></small>
            </div>
            <button id="logout-btn" class="logout-btn">Log Out</button>
        </div>

        <div class="card">
            <h2>ðŸ“¢ Pending Farmer Requests</h2>
            <p style="color: #666; font-size: 0.9em;">Approve these items to add them to the shop.</p>
            
            <table>
                <thead>
                    <tr>
                        <th>Image</th>
                        <th>Details</th>
                        <th>Price (LKR)</th>
                        <th>Farmer</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="offers-table-body">
                    </tbody>
            </table>
            <p id="no-offers-msg" style="text-align: center; color: gray; display: none; margin-top: 20px;">
                No pending requests.
            </p>
        </div>

        <div class="card">
            <h2>âž• Add Product Manually</h2>
            <form id="add-product-form">
                <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" id="product-name" placeholder="e.g. Red Apple" required>
                </div>

                <div class="form-group">
                    <label>Price (LKR)</label>
                    <input type="number" id="product-price" placeholder="e.g. 150" required>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select id="product-category">
                        <option value="vegetables">Vegetables</option>
                        <option value="fruits">Fruits</option>
                        <option value="dairy">Dairy</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Image URL</label>
                    <input type="url" id="product-image" placeholder="https://..." required>
                </div>

                <button type="submit" class="submit-btn">Upload to Shop</button>
            </form>
        </div>
    </div>

    <script type="module">
        // --- IMPORTS ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { 
            getFirestore, collection, addDoc, getDocs, deleteDoc, doc, getDoc 
        } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        
        // Import your secrets
        import { firebaseConfig, ADMIN_EMAIL } from './config.js';

        // --- INITIALIZE ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // --- AUTH & SECURITY CHECK ---
        onAuthStateChanged(auth, (user) => {
            const loading = document.getElementById('loading-screen');
            const dashboard = document.getElementById('dashboard-content');

            if (user && user.email === ADMIN_EMAIL) {
                // Success: Show Dashboard
                console.log("Admin Logged In");
                loading.style.display = 'none';
                dashboard.style.display = 'block';
                document.getElementById('admin-email-display').textContent = user.email;
                
                // Load Data
                loadFarmerOffers();
            } else {
                // Fail: Redirect
                alert("Access Denied: You are not the admin.");
                window.location.href = "index.html"; 
            }
        });

        // Logout Logic
        document.getElementById('logout-btn').addEventListener('click', () => {
            signOut(auth).then(() => window.location.href = "index.html");
        });

        async function loadFarmerOffers() {
            const tableBody = document.getElementById('offers-table-body');
            const noMsg = document.getElementById('no-offers-msg');
            
            tableBody.innerHTML = ""; 

            try {
                // Get data from "farmerRequests" collection
                const snapshot = await getDocs(collection(db, "farmerRequests"));

                if (snapshot.empty) {
                    noMsg.style.display = "block";
                    return;
                } else {
                    noMsg.style.display = "none";
                }

                snapshot.forEach((docSnap) => {
                    const data = docSnap.data();
                    const id = docSnap.id;

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><img src="${data.imageUrl}" class="table-img" alt="item"></td>
                        <td>
                            <strong>${data.name}</strong><br>
                            <small>${data.category}</small>
                        </td>
                        <td>LKR ${data.price}</td>
                        <td>
                            ${data.farmerName || 'Unknown'}<br>
                            <small>${data.contact || ''}</small>
                        </td>
                        <td>
                            <button class="btn-approve" data-id="${id}">âœ“ Approve</button>
                            <button class="btn-reject" data-id="${id}">âœ• Reject</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });

                // Attach Event Listeners to the new buttons
                document.querySelectorAll('.btn-approve').forEach(btn => {
                    btn.addEventListener('click', (e) => approveOffer(e.target.dataset.id));
                });
                document.querySelectorAll('.btn-reject').forEach(btn => {
                    btn.addEventListener('click', (e) => rejectOffer(e.target.dataset.id));
                });

            } catch (error) {
                console.error("Error loading offers:", error);
            }
        }

        // --- APPROVE FUNCTION ---
        async function approveOffer(docId) {
            if(!confirm("Approve this item? It will appear in the shop.")) return;

            try {
                // 1. Get original data
                const ref = doc(db, "farmerRequests", docId);
                const snap = await getDoc(ref);
                if (!snap.exists()) return;
                const data = snap.data();

                // 2. Add to "products" (The Shop)
                await addDoc(collection(db, "products"), {
                    name: data.name,
                    price: Number(data.price),
                    category: data.category,
                    imageUrl: data.imageUrl,
                    farmerId: data.farmerId || 'unknown',
                    createdAt: new Date()
                });

                // 3. Delete from requests
                await deleteDoc(ref);
                
                alert("Approved! Moved to shop.");
                loadFarmerOffers();

            } catch (err) {
                console.error(err);
                alert("Error approving item.");
            }
        }

        // --- REJECT FUNCTION ---
        async function rejectOffer(docId) {
            if(!confirm("Delete this request?")) return;
            try {
                await deleteDoc(doc(db, "farmerRequests", docId));
                alert("Request deleted.");
                loadFarmerOffers();
            } catch (err) {
                console.error(err);
            }
        }

        document.getElementById('add-product-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('product-name').value;
            const price = document.getElementById('product-price').value;
            const category = document.getElementById('product-category').value;
            const image = document.getElementById('product-image').value;

            try {
                await addDoc(collection(db, "products"), {
                    name: name,
                    price: Number(price),
                    category: category,
                    imageUrl: image,
                    createdAt: new Date(),
                    farmerId: 'admin'
                });
                alert("Product Added Successfully!");
                e.target.reset();
            } catch (error) {
                console.error("Error adding product: ", error);
                alert("Failed to add product.");
            }
        });
    </script>
</body>
</html>